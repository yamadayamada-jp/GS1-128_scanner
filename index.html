<!DOCTYPE html>
<html lang="ja" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GS1-128 バーコードスキャナ (画像アップロード対応)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ZXing (Zebra Crossing) Barcode Scanning Library CDN -->
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <style>
        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        #video-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #result-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            transition: all 0.3s ease-in-out;
            background-color: #1a202c;
            /* bg-gray-900 */
        }

        #uploaded-image-preview {
            max-width: 100%;
            max-height: 200px;
            /* プレビュー画像の最大高さ */
            object-fit: contain;
            margin-top: 1rem;
            border-radius: 0.5rem;
            display: none;
            /* 初期は非表示 */
        }

        /* ロード中のスピナー */
        .loader {
            border: 4px solid #f3f3f3;
            /* Light grey */
            border-top: 4px solid #3498db;
            /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* AI分割結果表示エリアのスタイル */
        #parsed-result-container {
            background-color: #2d3748;
            /* bg-gray-700 */
            color: #e2e8f0;
            /* text-gray-200 */
            padding: 0.75rem;
            /* p-3 */
            border-radius: 0.375rem;
            /* rounded-md */
            font-family: monospace;
            white-space: pre-wrap;
            /* 自動折り返し */
            overflow: auto;
            /* 修正: スクロール */
            max-height: 300px;
            /* 修正: 高さを増やす */
            display: none;
            /* 初期は非表示 */
            line-height: 1.5;
        }

        /* スキャン中のUI調整 */
        #result-container.scanning-active #resultTextarea,
        #result-container.scanning-active #parsed-result-label,
        #result-container.scanning-active #parsed-result-container,
        #result-container.scanning-active #copyButton,
        #result-container.scanning-active label[for="imageUpload"] {
            display: none;
        }

        #result-container.scanning-active .grid {
            grid-template-columns: 1fr;
        }

        #result-container.scanning-active #startButton {
            display: none;
        }

        #result-container.scanning-active {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
    </style>
</head>

<body class="bg-gray-900 text-white font-sans h-full flex flex-col">

    <!-- メインコンテナ -->
    <div class="relative flex-grow h-full w-full overflow-hidden">

        <!-- カメラプレビュー -->
        <div id="video-container" class="absolute inset-0 bg-black">
            <video id="video-preview" playsinline></video>
            <!-- アップロード画像プレビュー --><img id="uploaded-image-preview" class="absolute inset-0 m-auto"
                alt="Uploaded Barcode Image">
        </div>

        <!-- スキャン中のインジケーター -->
        <div id="scanner-guide" class="absolute inset-0 flex items-center justify-center pointer-events-none hidden">
            <div class="w-3/4 max-w-md h-48 border-4 border-dashed border-red-500 rounded-lg opacity-75 animate-pulse">
                <div class="relative w-full h-full">
                    <div class="absolute top-0 left-0 w-10 h-10 border-t-4 border-l-4 border-red-500 rounded-tl-lg">
                    </div>
                    <div class="absolute top-0 right-0 w-10 h-10 border-t-4 border-r-4 border-red-500 rounded-tr-lg">
                    </div>
                    <div class="absolute bottom-0 left-0 w-10 h-10 border-b-4 border-l-4 border-red-500 rounded-bl-lg">
                    </div>
                    <div class="absolute bottom-0 right-0 w-10 h-10 border-b-4 border-r-4 border-red-500 rounded-br-lg">
                    </div>
                </div>
            </div>
        </div>

        <!-- ヘッダー -->
        <div class="absolute top-0 left-0 right-0 p-4 bg-gradient-to-b from-black/70 to-transparent">
            <h1 class="text-xl font-bold text-center">GS1-128 スキャナ</h1>
            <p id="status-message" class="text-center text-gray-300 text-sm mt-1">「スキャン開始」または「画像からスキャン」を選択してください。</p>
        </div>

        <!-- 結果表示コンテナ -->
        <div id="result-container" class="p-4 bg-gray-800 rounded-t-lg shadow-lg">

            <!-- コントロールボタン -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <button id="startButton"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105">
                    カメラでスキャン
                </button>
                <button id="stopButton"
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out"
                    disabled>
                    停止
                </button>
                <label for="imageUpload"
                    class="col-span-2 bg-purple-600 hover:bg-purple-700 text-white text-center font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 cursor-pointer">
                    画像からスキャン
                    <input type="file" id="imageUpload" accept="image/*" class="hidden">
                </label>
            </div>

            <!-- 結果表示エリア --><label for="resultTextarea" class="block text-sm font-medium text-gray-300 mb-1">スキャン結果
                (Raw):</label>
            <textarea id="resultTextarea" rows="6"
                class="w-full p-2 bg-gray-900 border border-gray-700 rounded-md text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
                readonly placeholder="ここにバーコードデータが表示されます..."></textarea>

            <!-- AI分割結果表示エリア -->
            <label id="parsed-result-label" for="parsed-result-container"
                class="block text-sm font-medium text-gray-300 mb-1 mt-3 hidden">AI分割情報:</label>
            <pre id="parsed-result-container"></pre>

            <!-- コピーボタン --><button id="copyButton"
                class="mt-3 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out">
                一番上の結果(Raw)をコピー
            </button>
        </div>
    </div>

    <!-- メッセージ表示用モーダル -->
    <div id="message-modal"
        class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full">
            <h3 id="message-title" class="text-lg font-bold text-gray-900"></h3>
            <p id="message-body" class="text-sm text-gray-700 mt-2"></p>
            <button id="close-modal-button"
                class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                閉じる
            </button>
        </div>
    </div>


    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof ZXing === 'undefined') {
                console.error('ZXing library not loaded.');
                showMessage('エラー', 'スキャンライブラリの読み込みに失敗しました。');
                return;
            }

            const { BrowserMultiFormatReader, BarcodeFormat } = ZXing;

            const hints = new Map();
            const formats = [BarcodeFormat.CODE_128];
            hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
            hints.set(ZXing.DecodeHintType.TRY_HARDER, true);

            const codeReader = new BrowserMultiFormatReader(hints);

            const videoElement = document.getElementById('video-preview');
            const uploadedImagePreview = document.getElementById('uploaded-image-preview');
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            const imageUpload = document.getElementById('imageUpload');
            const resultTextarea = document.getElementById('resultTextarea');
            const parsedResultContainer = document.getElementById('parsed-result-container');
            const parsedResultLabel = document.getElementById('parsed-result-label');
            const statusMessage = document.getElementById('status-message');
            const scannerGuide = document.getElementById('scanner-guide');
            const copyButton = document.getElementById('copyButton');
            const resultContainer = document.getElementById('result-container');

            const messageModal = document.getElementById('message-modal');
            const messageTitle = document.getElementById('message-title');
            const messageBody = document.getElementById('message-body');
            const closeModalButton = document.getElementById('close-modal-button');

            let currentStream = null;

            function showMessage(title, body) {
                messageTitle.textContent = title;
                messageBody.textContent = body;
                messageModal.classList.remove('hidden');
            }

            closeModalButton.addEventListener('click', () => {
                messageModal.classList.add('hidden');
            });

            function updateStatus(message, showLoader = false) {
                if (showLoader) {
                    statusMessage.innerHTML = `<span class="loader"></span>${message}`;
                } else {
                    statusMessage.textContent = message;
                }
            }

            // --- GS1-128 Parser ---
            const FNC1 = '\x1D';
            const gs1AIDefinitions = {
                '00': { description: 'SSCC', length: 18, isVariable: false },
                '01': { description: 'GTIN', length: 14, isVariable: false },
                '02': { description: 'Content GTIN', length: 14, isVariable: false },
                '10': { description: 'Batch/Lot Number', maxLength: 20, isVariable: true },
                '11': { description: 'Production Date (YYMMDD)', length: 6, isVariable: false },
                '13': { description: 'Packaging Date (YYMMDD)', length: 6, isVariable: false },
                '15': { description: 'Best Before Date (YYMMDD)', length: 6, isVariable: false },
                '17': { description: 'Expiration Date (YYMMDD)', length: 6, isVariable: false },
                '21': { description: 'Serial Number', maxLength: 20, isVariable: true },
                '30': { description: 'Count', maxLength: 8, isVariable: true },
                '37': { description: 'Count (Trade Units)', maxLength: 8, isVariable: true },
                '3100': { description: 'Net Weight (kg, d=0)', length: 6, isVariable: false, d: 0 },
                '3101': { description: 'Net Weight (kg, d=1)', length: 6, isVariable: false, d: 1 },
                '3102': { description: 'Net Weight (kg, d=2)', length: 6, isVariable: false, d: 2 },
                '3103': { description: 'Net Weight (kg, d=3)', length: 6, isVariable: false, d: 3 },
                '3104': { description: 'Net Weight (kg, d=4)', length: 6, isVariable: false, d: 4 },
                '3105': { description: 'Net Weight (kg, d=5)', length: 6, isVariable: false, d: 5 },
            };
            const gs1VariableDecimalAIs = [
                { prefix: '310', description: 'Net Weight (kg, d=', length: 6, suffix: ')' },
                { prefix: '311', description: 'Length (m, d=', length: 6, suffix: ')' },
                { prefix: '312', description: 'Width (m, d=', length: 6, suffix: ')' },
                { prefix: '313', description: 'Height (m, d=', length: 6, suffix: ')' },
                { prefix: '314', description: 'Area (m2, d=', length: 6, suffix: ')' },
                { prefix: '315', description: 'Volume (l, d=', length: 6, suffix: ')' },
                { prefix: '316', description: 'Volume (m3, d=', length: 6, suffix: ')' },
            ];

            function startsWithKnownAI(data) {
                if (data.length >= 4) {
                    const ai4 = data.substring(0, 4);
                    if (gs1AIDefinitions[ai4]) return true;
                    const aiPrefix = data.substring(0, 3);
                    if (gs1VariableDecimalAIs.find(d => d.prefix === aiPrefix)) return true;
                }
                if (data.length >= 2) {
                    const ai2 = data.substring(0, 2);
                    if (gs1AIDefinitions[ai2]) return true;
                }
                return false;
            }

            function parseGS1Data(data) {
                let remainingData = data;
                const parsedElements = [];
                while (remainingData.length > 0) {
                    let aiFound = false;
                    let ai = '';
                    let def = null;
                    let dataStartIndex = 0;
                    if (remainingData.length >= 4) {
                        ai = remainingData.substring(0, 4);
                        if (gs1AIDefinitions[ai]) {
                            aiFound = true;
                            def = gs1AIDefinitions[ai];
                            dataStartIndex = 4;
                        } else {
                            const aiPrefix = remainingData.substring(0, 3);
                            const aiVariable = gs1VariableDecimalAIs.find(d => d.prefix === aiPrefix);
                            if (aiVariable) {
                                aiFound = true;
                                const d = remainingData.substring(3, 4);
                                ai = aiPrefix + d;
                                def = {
                                    description: `${aiVariable.description}${d}${aiVariable.suffix}`,
                                    length: aiVariable.length,
                                    isVariable: false,
                                    d: parseInt(d, 10)
                                };
                                dataStartIndex = 4;
                            }
                        }
                    }
                    if (!aiFound && remainingData.length >= 2) {
                        ai = remainingData.substring(0, 2);
                        if (gs1AIDefinitions[ai]) {
                            aiFound = true;
                            def = gs1AIDefinitions[ai];
                            dataStartIndex = 2;
                        }
                    }
                    if (aiFound) {
                        remainingData = parseElement(ai, def, remainingData.substring(dataStartIndex), parsedElements);
                    } else {
                        if (remainingData.length > 0) {
                            parsedElements.push({
                                ai: '??',
                                data: remainingData,
                                description: 'Unknown data or parsing error'
                            });
                        }
                        break;
                    }
                }
                return parsedElements;
            }

            function parseElement(ai, def, data, parsedElements) {
                let elementData = '';
                let remainingData = data;
                if (def.isVariable) {
                    const separatorIndex = data.indexOf(FNC1);
                    const maxLength = def.maxLength;
                    if (separatorIndex !== -1) {
                        elementData = data.substring(0, separatorIndex);
                        remainingData = data.substring(separatorIndex + 1);
                        if (elementData.length > maxLength) {
                            elementData = elementData.substring(0, maxLength);
                        }
                    } else {
                        if (data.length > maxLength) {
                            elementData = data.substring(0, maxLength);
                            remainingData = data.substring(maxLength);
                        } else {
                            elementData = data;
                            remainingData = '';
                        }
                    }
                } else {
                    const length = def.length;
                    if (data.length >= length) {
                        elementData = data.substring(0, length);
                        remainingData = data.substring(length);
                    } else {
                        elementData = data;
                        remainingData = '';
                    }
                }
                if (def.d !== undefined) {
                    const d = def.d;
                    if (elementData.length === def.length) {
                        const integerPart = elementData.substring(0, def.length - d);
                        const decimalPart = elementData.substring(def.length - d);
                        elementData = `${integerPart}.${decimalPart}`;
                    }
                }
                parsedElements.push({
                    ai: ai,
                    data: elementData,
                    description: def.description
                });
                return remainingData;
            }
            // --- End GS1 Parser ---


            function stopScan() {
                resultContainer.classList.remove('scanning-active');
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
                codeReader.reset();
                videoElement.srcObject = null;
                videoElement.classList.remove('hidden');
                uploadedImagePreview.src = '';
                uploadedImagePreview.classList.add('hidden');
                updateStatus('スキャンが停止しました。');
                scannerGuide.classList.add('hidden');

                resultTextarea.value = '';
                parsedResultContainer.textContent = '';
                parsedResultContainer.style.display = 'none';
                parsedResultLabel.classList.add('hidden');

                startButton.disabled = false;
                stopButton.disabled = true;
                imageUpload.closest('label').classList.remove('pointer-events-none', 'opacity-50');
            }

            // --- 修正: 複数結果を処理する関数 ---
            function processScanResults(results) {
                if (results && results.length > 0) {

                    let allRawText = '';
                    let allParsedText = '';

                    // 結果をループ処理
                    results.forEach((result, index) => {
                        console.log(`Scan result ${index + 1}:`, result);

                        const rawText = result.getText();
                        let formatType = "不明";
                        let gs1Data = '';

                        if (index > 0) {
                            allRawText += '\n---\n'; // Raw結果の区切り文字
                            allParsedText += `\n--- (結果 ${index + 1}) ---\n`; // AI分割結果の区切り文字
                        }

                        if (result.getBarcodeFormat() === BarcodeFormat.CODE_128) {
                            const fnc1Index = rawText.indexOf(FNC1);
                            const c1Prefix = rawText.startsWith(']C1');
                            const hasInternalFNC1 = fnc1Index > 0;
                            const rawKnownAIStart = startsWithKnownAI(rawText);

                            if (c1Prefix || fnc1Index === 0 || hasInternalFNC1 || rawKnownAIStart) {
                                formatType = "GS1-128";
                                if (c1Prefix) {
                                    gs1Data = rawText.substring(3);
                                } else if (fnc1Index === 0) {
                                    gs1Data = rawText.substring(1);
                                } else {
                                    gs1Data = rawText;
                                }

                                allRawText += gs1Data;

                                const parsedElements = parseGS1Data(gs1Data);
                                if (parsedElements.length > 0) {
                                    const formattedOutput = parsedElements.map(el => {
                                        const aiStr = `(${el.ai})`.padEnd(7, ' ');
                                        const dataStr = el.data.padEnd(25, ' ');
                                        return `${aiStr} ${dataStr} -> ${el.description}`;
                                    }).join('\n');
                                    allParsedText += formattedOutput;
                                } else {
                                    allParsedText += "(AI分割情報なし)";
                                }

                            } else {
                                formatType = "Code 128 (非GS1)";
                                allRawText += rawText;
                                allParsedText += `[Code 128 (非GS1)]\n${rawText}`;
                            }
                        } else {
                            formatType = result.getBarcodeFormat().toString();
                            allRawText += rawText;
                            allParsedText += `[${formatType}]\n${rawText}`;
                        }
                    }); // end forEach

                    resultTextarea.value = allRawText;
                    parsedResultContainer.textContent = allParsedText;
                    parsedResultContainer.style.display = 'block';
                    parsedResultLabel.classList.remove('hidden');

                    updateStatus(`${results.length} 件のバーコードを検出しました！`);
                    if ('vibrate' in navigator) {
                        navigator.vibrate(200);
                    }

                    if (currentStream) {
                        stopScan(); // カメラは停止
                    } else {
                        // 画像スキャンの場合はボタンを有効化
                        updateStatus(`${results.length} 件のバーコードを検出しました！`);
                        startButton.disabled = false;
                        imageUpload.closest('label').classList.remove('pointer-events-none', 'opacity-50');
                        imageUpload.value = '';
                    }

                } else {
                    updateStatus('バーコードを検出できませんでした。');
                    if (currentStream) {
                        // カメラは停止しない (リアルタイムスキャンは継続)
                    } else {
                        // 画像スキャンの場合は失敗メッセージ
                        showMessage('検出失敗', 'この画像からバーコードを検出できませんでした。');
                        updateStatus('画像解析に失敗しました。');
                        startButton.disabled = false;
                        imageUpload.closest('label').classList.remove('pointer-events-none', 'opacity-50');
                        imageUpload.value = '';
                    }
                }
            }
            // --- 修正ここまで ---

            startButton.addEventListener('click', async () => {
                resultContainer.classList.add('scanning-active');
                startButton.disabled = true;
                stopButton.disabled = false;
                imageUpload.closest('label').classList.add('pointer-events-none', 'opacity-50');
                resultTextarea.value = '';
                parsedResultContainer.textContent = '';
                parsedResultContainer.style.display = 'none';
                parsedResultLabel.classList.add('hidden');
                updateStatus('カメラを起動中...', true);
                uploadedImagePreview.classList.add('hidden');
                videoElement.classList.remove('hidden');

                try {
                    const constraints = {
                        video: {
                            facingMode: 'environment'
                        }
                    };
                    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    videoElement.srcObject = currentStream;
                    await videoElement.play();
                    updateStatus('バーコードをスキャンしてください...');
                    scannerGuide.classList.remove('hidden');

                    codeReader.decodeFromVideoDevice(undefined, videoElement, (result, err) => {
                        if (result) {
                            // --- 修正: 複数結果を処理する関数に配列として渡す ---
                            processScanResults([result]);
                            // リアルタイムスキャンの場合、成功したら（processScanResults内で）stopScanが呼ばれる
                        } else if (err) {
                            if (!(err instanceof ZXing.NotFoundException) && !(err instanceof ZXing.ChecksumException) && !(err instanceof ZXing.FormatException)) {
                                console.error('Scanning error:', err);
                            }
                        }
                    });

                } catch (err) {
                    console.error('Camera access error:', err);
                    let errorMessage = 'カメラの起動に失敗しました。';
                    if (err.name === 'NotAllowedError') {
                        errorMessage = 'カメラへのアクセスが拒否されました。ブラウザの設定を確認してください。';
                    } else if (err.name === 'NotFoundError') {
                        errorMessage = '使用可能なカメラが見つかりませんでした。';
                    } else if (err.name === 'NotReadableError') {
                        errorMessage = 'カメラが他のアプリケーションで使用されている可能性があります。';
                    }
                    showMessage('カメラエラー', errorMessage);
                    updateStatus('エラーが発生しました。');
                    stopScan();
                }
            });

            stopButton.addEventListener('click', stopScan);

            imageUpload.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                stopScan();
                startButton.disabled = true;
                imageUpload.closest('label').classList.add('pointer-events-none', 'opacity-50');
                resultTextarea.value = '';
                parsedResultContainer.textContent = '';
                parsedResultContainer.style.display = 'none';
                parsedResultLabel.classList.add('hidden');
                updateStatus('画像を解析中...', true);

                const reader = new FileReader();

                reader.onload = async (e) => {
                    uploadedImagePreview.src = e.target.result;

                    uploadedImagePreview.onload = async () => {
                        videoElement.classList.add('hidden');
                        uploadedImagePreview.classList.remove('hidden');

                        try {
                            // --- 修正: decodeMultipleFromImageElement を使用 ---
                            const results = await codeReader.decodeMultipleFromImageElement(uploadedImagePreview);

                            if (results && results.length > 0) {
                                // --- 修正: 中心に近い順にソート ---
                                const imgCenterX = uploadedImagePreview.naturalWidth / 2;
                                const imgCenterY = uploadedImagePreview.naturalHeight / 2;

                                results.sort((a, b) => {
                                    const centerA = getResultCenter(a.getResultPoints());
                                    const centerB = getResultCenter(b.getResultPoints());

                                    const distA = Math.pow(centerA.x - imgCenterX, 2) + Math.pow(centerA.y - imgCenterY, 2);
                                    const distB = Math.pow(centerB.x - imgCenterX, 2) + Math.pow(centerB.y - imgCenterY, 2);

                                    return distA - distB; // 距離が小さい順
                                });
                                // --- ソートここまで ---

                                processScanResults(results); // ソート済みの複数結果を渡す

                            } else {
                                // 結果が空 (検出失敗)
                                processScanResults([]);
                            }

                        } catch (err) {
                            console.error('Image scan error:', err);
                            // NotFoundException も含め、エラー時は空の結果として扱う
                            processScanResults([]);
                        }
                        // finally は processScanResults 内で処理される
                    };

                    uploadedImagePreview.onerror = () => {
                        showMessage('エラー', '画像ファイルの読み込みに失敗しました。');
                        updateStatus('画像読み込みエラー');
                        startButton.disabled = false;
                        imageUpload.closest('label').classList.remove('pointer-events-none', 'opacity-50');
                        imageUpload.value = '';
                    };
                };

                reader.readAsDataURL(file);
            });

            // --- 修正: バーコードの中心座標を取得するヘルパー関数 ---
            function getResultCenter(points) {
                if (!points || points.length === 0) {
                    return { x: 0, y: 0 };
                }
                const sumX = points.reduce((sum, p) => sum + p.getX(), 0);
                const sumY = points.reduce((sum, p) => sum + p.getY(), 0);
                return {
                    x: sumX / points.length,
                    y: sumY / points.length
                };
            }
            // --- 修正ここまで ---


            copyButton.addEventListener('click', () => {
                // --- 修正: 一番上の結果 (改行まで) をコピー ---
                const allText = resultTextarea.value;
                if (!allText) {
                    showMessage('コピー', 'コピーするデータがありません。');
                    return;
                }

                const firstResult = allText.split('\n---')[0]; // 区切り文字で分割して最初の要素を取得
                const textToCopy = firstResult.trim();
                // --- 修正ここまで ---

                if (navigator.clipboard) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        showMessage('コピー完了', '一番上の結果(Raw)をクリップボードにコピーしました。');
                    }).catch(err => {
                        console.error('Clipboard API error:', err);
                        legacyCopy(textToCopy); // フォールバック
                    });
                } else {
                    legacyCopy(textToCopy); // フォールバック
                }
            });

            function legacyCopy(text) {
                try {
                    // テキストエリアの値を一時的に変更してコピーする
                    const originalValue = resultTextarea.value;
                    resultTextarea.value = text;
                    resultTextarea.select();
                    document.execCommand('copy');
                    resultTextarea.value = originalValue; // 元に戻す
                    resultTextarea.blur();
                    showMessage('コピー完了', '一番上の結果(Raw)をクリップボードにコピーしました。');
                } catch (err) {
                    console.error('Legacy copy error:', err);
                    showMessage('コピー失敗', 'クリップボードへのコピーに失敗しました。');
                }
            }

            // 初期状態設定
            updateStatus('「カメラでスキャン」または「画像からスキャン」を選択してください。');
            stopButton.disabled = true;
        });
    </script>

</body>

</html>