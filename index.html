<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="ZXing for JS">

    <title>GS1-128 バーコードスキャナ</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* カメラ映像エリア（上部50%） */
        #video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 結果表示エリア（下部50%） */
        #result-container {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 50%;
            background-color: #f5f5f5;
            overflow-y: auto;
            padding: 20px;
        }

        /* スキャンガイド */
        #scanner-guide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        /* 読み取り範囲を示す箱型ガイド（黄色） */
        #scan-area-box {
            position: absolute;
            width: 95%;
            height: 35%;
            border: 2px dashed #ffff00;
            opacity: 0.6;
        }

        /* 中心線（赤） */
        #scanner-guide-box {
            position: absolute;
            width: 90%;
            max-width: 600px;
            height: 3px;
            background-color: #ff0000;
            opacity: 0.8;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.8;
            }
            50% {
                opacity: 0.4;
            }
        }

        /* Canvas（非表示） */
        #scan-canvas {
            display: none;
        }
    </style>
</head>

<body>

    <!-- カメラ映像エリア -->
    <div id="video-container">
        <video id="video" playsinline></video>
    </div>

    <!-- スキャンガイド -->
    <div id="scanner-guide">
        <!-- 読み取り範囲を示す箱型ガイド（黄色） -->
        <div id="scan-area-box"></div>
        <!-- 中心線（赤） -->
        <div id="scanner-guide-box"></div>
    </div>

    <!-- スキャン用Canvas（非表示） -->
    <canvas id="scan-canvas"></canvas>

    <!-- 結果表示エリア -->
    <div id="result-container">
        <h1>GS1-128 バーコードスキャナ</h1>

        <div style="margin: 20px 0;">
            <button id="startButton" style="padding: 10px 20px; font-size: 16px; margin-right: 10px;">スキャン開始</button>
            <button id="resetButton" style="padding: 10px 20px; font-size: 16px;">停止</button>
        </div>

        <div id="sourceSelectPanel" style="display:none; margin: 20px 0;">
            <label for="sourceSelect">カメラを選択:</label>
            <select id="sourceSelect" style="padding: 5px; font-size: 14px; margin-left: 10px;">
            </select>
        </div>

        <div style="margin: 20px 0;">
            <label style="font-weight: bold; display: block; margin-bottom: 10px;">スキャン結果:</label>
            <pre id="result" style="background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 4px; min-height: 100px; white-space: pre-wrap; word-wrap: break-word;"></pre>
        </div>
    </div>

    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <script type="text/javascript">
        window.addEventListener('load', function () {
            // --- GS1-128 Parser ---
            const FNC1 = '\x1D';
            const gs1AIDefinitions = {
                '00': { description: 'SSCC (Serial Shipping Container Code)', length: 18, isVariable: false },
                '01': { description: 'GTIN (Global Trade Item Number)', length: 14, isVariable: false },
                '02': { description: 'Content GTIN', length: 14, isVariable: false },
                '10': { description: 'Batch/Lot Number', maxLength: 20, isVariable: true },
                '11': { description: 'Production Date (YYMMDD)', length: 6, isVariable: false },
                '12': { description: 'Due Date (YYMMDD)', length: 6, isVariable: false },
                '13': { description: 'Packaging Date (YYMMDD)', length: 6, isVariable: false },
                '15': { description: 'Best Before Date (YYMMDD)', length: 6, isVariable: false },
                '17': { description: 'Expiration Date (YYMMDD)', length: 6, isVariable: false },
                '20': { description: 'Product Variant', length: 2, isVariable: false },
                '21': { description: 'Serial Number', maxLength: 20, isVariable: true },
                '22': { description: 'Secondary Data Fields', maxLength: 29, isVariable: true },
                '30': { description: 'Variable Count', maxLength: 8, isVariable: true },
                '37': { description: 'Count (Trade Units)', maxLength: 8, isVariable: true },
                '310': { description: 'Net Weight (kg)', length: 6, isVariable: false },
                '320': { description: 'Net Weight (lb)', length: 6, isVariable: false },
                '400': { description: 'Customer Purchase Order', maxLength: 30, isVariable: true },
                '410': { description: 'Ship To/Deliver To', length: 13, isVariable: false },
                '420': { description: 'Ship To Postal Code', maxLength: 20, isVariable: true }
            };

            function parseGS1Data(data) {
                let remainingData = data;
                const parsedElements = [];

                while (remainingData.length > 0) {
                    let aiFound = false;
                    let ai = '';
                    let def = null;
                    let dataStartIndex = 0;

                    // Try 4-digit AI first, then 3-digit, then 2-digit
                    for (let aiLength of [4, 3, 2]) {
                        if (remainingData.length >= aiLength) {
                            ai = remainingData.substring(0, aiLength);
                            if (gs1AIDefinitions[ai]) {
                                aiFound = true;
                                def = gs1AIDefinitions[ai];
                                dataStartIndex = aiLength;
                                break;
                            }
                        }
                    }

                    if (aiFound) {
                        let elementData = '';
                        if (def.isVariable) {
                            const separatorIndex = remainingData.substring(dataStartIndex).indexOf(FNC1);
                            const maxLength = def.maxLength;
                            if (separatorIndex !== -1) {
                                elementData = remainingData.substring(dataStartIndex, dataStartIndex + separatorIndex);
                                remainingData = remainingData.substring(dataStartIndex + separatorIndex + 1);
                            } else {
                                elementData = remainingData.substring(dataStartIndex, Math.min(remainingData.length, dataStartIndex + maxLength));
                                remainingData = remainingData.substring(dataStartIndex + elementData.length);
                            }
                        } else {
                            const length = def.length;
                            if (remainingData.length >= dataStartIndex + length) {
                                elementData = remainingData.substring(dataStartIndex, dataStartIndex + length);
                                remainingData = remainingData.substring(dataStartIndex + length);
                            } else {
                                elementData = remainingData.substring(dataStartIndex);
                                remainingData = '';
                            }
                        }

                        parsedElements.push({
                            ai: ai,
                            data: elementData,
                            description: def.description
                        });
                    } else {
                        // Unknown AI - try to skip the problematic part
                        if (remainingData.length > 0) {
                            // Look for the next FNC1 or take remaining data
                            const nextSeparator = remainingData.indexOf(FNC1);
                            if (nextSeparator > 0) {
                                parsedElements.push({
                                    ai: '??',
                                    data: remainingData.substring(0, nextSeparator),
                                    description: 'Unknown/Unparsed data'
                                });
                                remainingData = remainingData.substring(nextSeparator + 1);
                            } else {
                                parsedElements.push({
                                    ai: '??',
                                    data: remainingData,
                                    description: 'Unknown/Unparsed data'
                                });
                                remainingData = '';
                            }
                        }
                        break;
                    }
                }
                return parsedElements;
            }

            function formatGS1Result(rawText) {
                const parsedElements = parseGS1Data(rawText);
                let formatted = '';

                // Raw data with AI brackets
                formatted += 'Raw: ';
                parsedElements.forEach(el => {
                    formatted += `(${el.ai})${el.data}`;
                });
                formatted += '\n\nParsed:\n';

                // Formatted details
                parsedElements.forEach(el => {
                    const aiStr = `(${el.ai})`.padEnd(6, ' ');
                    const dataStr = el.data.padEnd(20, ' ');
                    formatted += `${aiStr} ${dataStr} -> ${el.description}\n`;
                });

                return formatted;
            }
            // --- End GS1 Parser ---

            // DOM要素
            const videoElement = document.getElementById('video');
            const scanCanvas = document.getElementById('scan-canvas');
            const scanCanvasCtx = scanCanvas.getContext('2d');
            const scannerGuide = document.getElementById('scanner-guide');
            const scanAreaBox = document.getElementById('scan-area-box');
            const sourceSelect = document.getElementById('sourceSelect');
            const sourceSelectPanel = document.getElementById('sourceSelectPanel');
            const resultElement = document.getElementById('result');
            const startButton = document.getElementById('startButton');
            const resetButton = document.getElementById('resetButton');

            let selectedDeviceId;
            let currentStream = null;
            let isScanning = false;
            let scanAnimationId = null;

            const codeReader = new ZXing.BrowserMultiFormatReader();
            console.log('ZXing code reader initialized');

            // カメラデバイスのリストを取得
            codeReader.listVideoInputDevices()
                .then((videoInputDevices) => {
                    selectedDeviceId = videoInputDevices[0].deviceId;

                    if (videoInputDevices.length >= 1) {
                        videoInputDevices.forEach((element) => {
                            const sourceOption = document.createElement('option');
                            sourceOption.text = element.label;
                            sourceOption.value = element.deviceId;
                            sourceSelect.appendChild(sourceOption);
                        });

                        sourceSelect.onchange = () => {
                            selectedDeviceId = sourceSelect.value;
                            // スキャン中なら再起動
                            if (isScanning) {
                                stopScan();
                                setTimeout(() => startScan(), 100);
                            }
                        };

                        sourceSelectPanel.style.display = 'block';
                    }
                })
                .catch((err) => {
                    console.error(err);
                    resultElement.textContent = 'カメラデバイスの取得に失敗しました。';
                });

            // カスタムスキャンループ
            function scanLoop() {
                if (!isScanning || !currentStream) {
                    return;
                }

                // スキャンエリアの位置とサイズを取得
                const areaRect = scanAreaBox.getBoundingClientRect();
                const videoRect = videoElement.getBoundingClientRect();

                // ビデオの実際の解像度
                const videoWidth = videoElement.videoWidth;
                const videoHeight = videoElement.videoHeight;

                if (videoWidth === 0 || videoHeight === 0) {
                    scanAnimationId = requestAnimationFrame(scanLoop);
                    return;
                }

                // スケールを計算
                const scaleX = videoWidth / videoRect.width;
                const scaleY = videoHeight / videoRect.height;

                // スキャンエリアをビデオ座標に変換
                const cropX = (areaRect.left - videoRect.left) * scaleX;
                const cropY = (areaRect.top - videoRect.top) * scaleY;
                const cropWidth = areaRect.width * scaleX;
                const cropHeight = areaRect.height * scaleY;

                // 範囲チェック
                const finalCropX = Math.max(0, cropX);
                const finalCropY = Math.max(0, cropY);
                const finalCropWidth = Math.min(cropWidth, videoWidth - finalCropX);
                const finalCropHeight = Math.min(cropHeight, videoHeight - finalCropY);

                // Canvasに切り出し
                scanCanvas.width = finalCropWidth;
                scanCanvas.height = finalCropHeight;

                if (finalCropWidth > 0 && finalCropHeight > 0) {
                    scanCanvasCtx.drawImage(
                        videoElement,
                        finalCropX, finalCropY, finalCropWidth, finalCropHeight,
                        0, 0, finalCropWidth, finalCropHeight
                    );

                    // CanvasをImage要素に変換してデコード
                    const img = new Image();
                    img.onload = () => {
                        codeReader.decodeFromImageElement(img)
                            .then(result => {
                                console.log(result);

                                // スキャン成功
                                stopScan();

                                // Check if it's CODE_128 (format 4)
                                if (result.format === 4) {
                                    // Parse as GS1-128
                                    const formatted = formatGS1Result(result.text);
                                    resultElement.textContent = formatted;
                                } else {
                                    // Display as-is for other formats
                                    resultElement.textContent = `Format: ${result.format}\n${result.text}`;
                                }
                            })
                            .catch(err => {
                                // 検出失敗、次のフレームへ
                                if (isScanning) {
                                    scanAnimationId = requestAnimationFrame(scanLoop);
                                }
                            });
                    };
                    img.src = scanCanvas.toDataURL();
                } else {
                    scanAnimationId = requestAnimationFrame(scanLoop);
                }
            }

            // スキャン開始
            async function startScan() {
                try {
                    const constraints = {
                        video: {
                            deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined,
                            facingMode: 'environment'
                        }
                    };

                    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    videoElement.srcObject = currentStream;
                    await videoElement.play();

                    console.log('Camera started');
                    console.log('Video dimensions:', videoElement.videoWidth, 'x', videoElement.videoHeight);

                    // スキャンガイドを表示
                    scannerGuide.style.display = 'flex';
                    isScanning = true;
                    scanLoop();
                } catch (err) {
                    console.error('Camera access error:', err);
                    resultElement.textContent = 'カメラの起動に失敗しました: ' + err.message;
                }
            }

            // スキャン停止
            function stopScan() {
                isScanning = false;

                if (scanAnimationId) {
                    cancelAnimationFrame(scanAnimationId);
                    scanAnimationId = null;
                }

                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }

                videoElement.srcObject = null;
                scannerGuide.style.display = 'none';
                console.log('Scan stopped');
            }

            // イベントリスナー
            startButton.addEventListener('click', () => {
                if (!isScanning) {
                    startScan();
                }
            });

            resetButton.addEventListener('click', () => {
                stopScan();
                resultElement.textContent = '';
            });
        })
    </script>

</body>

</html>