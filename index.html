<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="ZXing for JS">

    <title>GS1-128 バーコードスキャナ</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* カメラ映像エリア（上部50%） */
        #video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 結果表示エリア（下部50%） */
        #result-container {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 50%;
            background-color: #f5f5f5;
            overflow-y: auto;
            padding: 20px;
        }
    </style>
</head>

<body>

    <!-- カメラ映像エリア -->
    <div id="video-container">
        <video id="video" playsinline></video>
    </div>

    <!-- 結果表示エリア -->
    <div id="result-container">
        <h1>GS1-128 バーコードスキャナ</h1>

        <div style="margin: 20px 0;">
            <button id="startButton" style="padding: 10px 20px; font-size: 16px; margin-right: 10px;">スキャン開始</button>
            <button id="resetButton" style="padding: 10px 20px; font-size: 16px;">停止</button>
        </div>

        <div id="sourceSelectPanel" style="display:none; margin: 20px 0;">
            <label for="sourceSelect">カメラを選択:</label>
            <select id="sourceSelect" style="padding: 5px; font-size: 14px; margin-left: 10px;">
            </select>
        </div>

        <div style="margin: 20px 0;">
            <label style="font-weight: bold; display: block; margin-bottom: 10px;">スキャン結果:</label>
            <pre id="result" style="background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 4px; min-height: 100px; white-space: pre-wrap; word-wrap: break-word;"></pre>
        </div>
    </div>

    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <script type="text/javascript">
        window.addEventListener('load', function () {
            // --- GS1-128 Parser ---
            const FNC1 = '\x1D';
            const gs1AIDefinitions = {
                '00': { description: 'SSCC (Serial Shipping Container Code)', length: 18, isVariable: false },
                '01': { description: 'GTIN (Global Trade Item Number)', length: 14, isVariable: false },
                '02': { description: 'Content GTIN', length: 14, isVariable: false },
                '10': { description: 'Batch/Lot Number', maxLength: 20, isVariable: true },
                '11': { description: 'Production Date (YYMMDD)', length: 6, isVariable: false },
                '12': { description: 'Due Date (YYMMDD)', length: 6, isVariable: false },
                '13': { description: 'Packaging Date (YYMMDD)', length: 6, isVariable: false },
                '15': { description: 'Best Before Date (YYMMDD)', length: 6, isVariable: false },
                '17': { description: 'Expiration Date (YYMMDD)', length: 6, isVariable: false },
                '20': { description: 'Product Variant', length: 2, isVariable: false },
                '21': { description: 'Serial Number', maxLength: 20, isVariable: true },
                '22': { description: 'Secondary Data Fields', maxLength: 29, isVariable: true },
                '30': { description: 'Variable Count', maxLength: 8, isVariable: true },
                '37': { description: 'Count (Trade Units)', maxLength: 8, isVariable: true },
                '310': { description: 'Net Weight (kg)', length: 6, isVariable: false },
                '320': { description: 'Net Weight (lb)', length: 6, isVariable: false },
                '400': { description: 'Customer Purchase Order', maxLength: 30, isVariable: true },
                '410': { description: 'Ship To/Deliver To', length: 13, isVariable: false },
                '420': { description: 'Ship To Postal Code', maxLength: 20, isVariable: true }
            };

            function parseGS1Data(data) {
                let remainingData = data;
                const parsedElements = [];

                while (remainingData.length > 0) {
                    let aiFound = false;
                    let ai = '';
                    let def = null;
                    let dataStartIndex = 0;

                    // Try 4-digit AI first, then 3-digit, then 2-digit
                    for (let aiLength of [4, 3, 2]) {
                        if (remainingData.length >= aiLength) {
                            ai = remainingData.substring(0, aiLength);
                            if (gs1AIDefinitions[ai]) {
                                aiFound = true;
                                def = gs1AIDefinitions[ai];
                                dataStartIndex = aiLength;
                                break;
                            }
                        }
                    }

                    if (aiFound) {
                        let elementData = '';
                        if (def.isVariable) {
                            const separatorIndex = remainingData.substring(dataStartIndex).indexOf(FNC1);
                            const maxLength = def.maxLength;
                            if (separatorIndex !== -1) {
                                elementData = remainingData.substring(dataStartIndex, dataStartIndex + separatorIndex);
                                remainingData = remainingData.substring(dataStartIndex + separatorIndex + 1);
                            } else {
                                elementData = remainingData.substring(dataStartIndex, Math.min(remainingData.length, dataStartIndex + maxLength));
                                remainingData = remainingData.substring(dataStartIndex + elementData.length);
                            }
                        } else {
                            const length = def.length;
                            if (remainingData.length >= dataStartIndex + length) {
                                elementData = remainingData.substring(dataStartIndex, dataStartIndex + length);
                                remainingData = remainingData.substring(dataStartIndex + length);
                            } else {
                                elementData = remainingData.substring(dataStartIndex);
                                remainingData = '';
                            }
                        }

                        parsedElements.push({
                            ai: ai,
                            data: elementData,
                            description: def.description
                        });
                    } else {
                        // Unknown AI - try to skip the problematic part
                        if (remainingData.length > 0) {
                            // Look for the next FNC1 or take remaining data
                            const nextSeparator = remainingData.indexOf(FNC1);
                            if (nextSeparator > 0) {
                                parsedElements.push({
                                    ai: '??',
                                    data: remainingData.substring(0, nextSeparator),
                                    description: 'Unknown/Unparsed data'
                                });
                                remainingData = remainingData.substring(nextSeparator + 1);
                            } else {
                                parsedElements.push({
                                    ai: '??',
                                    data: remainingData,
                                    description: 'Unknown/Unparsed data'
                                });
                                remainingData = '';
                            }
                        }
                        break;
                    }
                }
                return parsedElements;
            }

            function formatGS1Result(rawText) {
                const parsedElements = parseGS1Data(rawText);
                let formatted = '';

                // Raw data with AI brackets
                formatted += 'Raw: ';
                parsedElements.forEach(el => {
                    formatted += `(${el.ai})${el.data}`;
                });
                formatted += '\n\nParsed:\n';

                // Formatted details
                parsedElements.forEach(el => {
                    const aiStr = `(${el.ai})`.padEnd(6, ' ');
                    const dataStr = el.data.padEnd(20, ' ');
                    formatted += `${aiStr} ${dataStr} -> ${el.description}\n`;
                });

                return formatted;
            }
            // --- End GS1 Parser ---

            let selectedDeviceId;
            const codeReader = new ZXing.BrowserMultiFormatReader()
            console.log('ZXing code reader initialized')
            codeReader.listVideoInputDevices()
                .then((videoInputDevices) => {
                    const sourceSelect = document.getElementById('sourceSelect')
                    selectedDeviceId = videoInputDevices[0].deviceId
                    if (videoInputDevices.length >= 1) {
                        videoInputDevices.forEach((element) => {
                            const sourceOption = document.createElement('option')
                            sourceOption.text = element.label
                            sourceOption.value = element.deviceId
                            sourceSelect.appendChild(sourceOption)
                        })

                        sourceSelect.onchange = () => {
                            selectedDeviceId = sourceSelect.value;
                        };

                        const sourceSelectPanel = document.getElementById('sourceSelectPanel')
                        sourceSelectPanel.style.display = 'block'
                    }

                    document.getElementById('startButton').addEventListener('click', () => {
                        codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
                            if (result) {
                                console.log(result)

                                // Check if it's CODE_128 (format 4)
                                if (result.format === 4) {
                                    // Parse as GS1-128
                                    const formatted = formatGS1Result(result.text);
                                    document.getElementById('result').textContent = formatted;
                                } else {
                                    // Display as-is for other formats
                                    document.getElementById('result').textContent = `Format: ${result.format}\n${result.text}`;
                                }
                            }
                            if (err && !(err instanceof ZXing.NotFoundException)) {
                                console.error(err)
                                document.getElementById('result').textContent = err
                            }
                        })
                        console.log(`Started continous decode from camera with id ${selectedDeviceId}`)
                    })

                    document.getElementById('resetButton').addEventListener('click', () => {
                        codeReader.reset()
                        document.getElementById('result').textContent = '';
                        console.log('Reset.')
                    })

                })
                .catch((err) => {
                    console.error(err)
                })
        })
    </script>

</body>

</html>