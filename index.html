<!DOCTYPE html>
<html lang="ja" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GS1-128 バーコードスキャナ (画像アップロード対応)</title>
    <!-- Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    <!-- ZXing (Zebra Crossing) Barcode Scanning Library CDN --><script type="text/javascript" src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
        }
        #video-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        #result-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            transition: all 0.3s ease-in-out;
            background-color: #1a202c; /* bg-gray-900 */
        }
        #uploaded-image-preview {
            max-width: 100%;
            max-height: 200px; /* プレビュー画像の最大高さ */
            object-fit: contain;
            margin-top: 1rem;
            border-radius: 0.5rem;
            display: none; /* 初期は非表示 */
        }
        /* ロード中のスピナー */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* AI分割結果表示エリアのスタイル */
        #parsed-result-container {
            background-color: #2d3748; /* bg-gray-700 */
            color: #e2e8f0; /* text-gray-200 */
            padding: 0.75rem; /* p-3 */
            border-radius: 0.375rem; /* rounded-md */
            font-family: monospace;
            white-space: pre-wrap; /* 自動折り返し */
            overflow-x: auto;
            max-height: 150px; /* スクロール可能にする */
            display: none; /* 初期は非表示 */
            line-height: 1.5;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans h-full flex flex-col">

    <!-- メインコンテナ --><div class="relative flex-grow h-full w-full overflow-hidden">
        
        <!-- カメラプレビュー --><div id="video-container" class="absolute inset-0 bg-black">
            <video id="video-preview" playsinline></video>
            <!-- アップロード画像プレビュー (ビデオの上に重ねる) --><img id="uploaded-image-preview" class="absolute inset-0 m-auto" alt="Uploaded Barcode Image">
        </div>

        <!-- スキャン中のインジケーター (スキャンエリアのガイド) --><div id="scanner-guide" class="absolute inset-0 flex items-center justify-center pointer-events-none hidden">
            <div class="w-3/4 max-w-md h-48 border-4 border-dashed border-red-500 rounded-lg opacity-75 animate-pulse">
                <div class="relative w-full h-full">
                    <div class="absolute top-0 left-0 w-10 h-10 border-t-4 border-l-4 border-red-500 rounded-tl-lg"></div>
                    <div class="absolute top-0 right-0 w-10 h-10 border-t-4 border-r-4 border-red-500 rounded-tr-lg"></div>
                    <div class="absolute bottom-0 left-0 w-10 h-10 border-b-4 border-l-4 border-red-500 rounded-bl-lg"></div>
                    <div class="absolute bottom-0 right-0 w-10 h-10 border-b-4 border-r-4 border-red-500 rounded-br-lg"></div>
                </div>
            </div>
        </div>

        <!-- ヘッダー (ステータス表示) --><div class="absolute top-0 left-0 right-0 p-4 bg-gradient-to-b from-black/70 to-transparent">
            <h1 class="text-xl font-bold text-center">GS1-128 スキャナ</h1>
            <p id="status-message" class="text-center text-gray-300 text-sm mt-1">「スキャン開始」または「画像からスキャン」を選択してください。</p>
        </div>

        <!-- 結果表示コンテナ --><div id="result-container" class="p-4 bg-gray-800 rounded-t-lg shadow-lg">
            
            <!-- コントロールボタン --><div class="grid grid-cols-2 gap-4 mb-4">
                <button id="startButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105">
                    カメラでスキャン
                </button>
                <button id="stopButton" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out" disabled>
                    停止
                </button>
                <label for="imageUpload" class="col-span-2 bg-purple-600 hover:bg-purple-700 text-white text-center font-bold py-3 px-4 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-105 cursor-pointer">
                    画像からスキャン
                    <input type="file" id="imageUpload" accept="image/*" class="hidden">
                </label>
            </div>

            <!-- 結果表示エリア --><label for="resultTextarea" class="block text-sm font-medium text-gray-300 mb-1">スキャン結果 (Raw):</label>
            <textarea id="resultTextarea" rows="3" class="w-full p-2 bg-gray-900 border border-gray-700 rounded-md text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500" readonly placeholder="ここにバーコードデータが表示されます..."></textarea>
            
            <!-- AI分割結果表示エリア -->
            <label id="parsed-result-label" for="parsed-result-container" class="block text-sm font-medium text-gray-300 mb-1 mt-3 hidden">AI分割情報:</label>
            <pre id="parsed-result-container"></pre>
            
            <!-- コピーボタン --><button id="copyButton" class="mt-3 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 ease-in-out">
                結果(Raw)をコピー
            </button>
        </div>
    </div>

    <!-- メッセージ表示用モーダル --><div id="message-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full">
            <h3 id="message-title" class="text-lg font-bold text-gray-900"></h3>
            <p id="message-body" class="text-sm text-gray-700 mt-2"></p>
            <button id="close-modal-button" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                閉じる
            </button>
        </div>
    </div>


    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof ZXing === 'undefined') {
                console.error('ZXing library not loaded.');
                showMessage('エラー', 'スキャンライブラリの読み込みに失敗しました。');
                return;
            }

            const { BrowserMultiFormatReader, BarcodeFormat } = ZXing;
            
            const hints = new Map();
            const formats = [BarcodeFormat.CODE_128];
            hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
            
            // GS1-128を想定
            hints.set(ZXing.DecodeHintType.ASSUME_GS1, true); 


            const codeReader = new BrowserMultiFormatReader(hints);

            const videoElement = document.getElementById('video-preview');
            const uploadedImagePreview = document.getElementById('uploaded-image-preview');
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            const imageUpload = document.getElementById('imageUpload');
            const resultTextarea = document.getElementById('resultTextarea');
            const parsedResultContainer = document.getElementById('parsed-result-container');
            const parsedResultLabel = document.getElementById('parsed-result-label');
            const statusMessage = document.getElementById('status-message');
            const scannerGuide = document.getElementById('scanner-guide');
            const copyButton = document.getElementById('copyButton');
            
            const messageModal = document.getElementById('message-modal');
            const messageTitle = document.getElementById('message-title');
            const messageBody = document.getElementById('message-body');
            const closeModalButton = document.getElementById('close-modal-button');

            let currentStream = null;

            function showMessage(title, body) {
                messageTitle.textContent = title;
                messageBody.textContent = body;
                messageModal.classList.remove('hidden');
            }
            
            closeModalButton.addEventListener('click', () => {
                messageModal.classList.add('hidden');
            });

            function updateStatus(message, showLoader = false) {
                if (showLoader) {
                    statusMessage.innerHTML = `<span class="loader"></span>${message}`;
                } else {
                    statusMessage.textContent = message;
                }
            }

            // --- GS1-128 Parser ---
            
            // FNC1 / Group Separator
            // ZXingはデコード時にデータストリーム内のFNC1 (GS) を \x1D として返すことを期待
            const FNC1 = '\x1D'; 

            // GS1 AI 定義 (主要なもの)
            // length: AI自体を含まないデータの固定長
            // maxLength: AI自体を含まないデータの最大可変長
            const gs1AIDefinitions = {
                // (AI): { description, length (固定) or maxLength (可変), isVariable }
                '00': { description: 'SSCC', length: 18, isVariable: false },
                '01': { description: 'GTIN', length: 14, isVariable: false },
                '02': { description: 'Content GTIN', length: 14, isVariable: false },
                '10': { description: 'Batch/Lot Number', maxLength: 20, isVariable: true },
                '11': { description: 'Production Date (YYMMDD)', length: 6, isVariable: false },
                '13': { description: 'Packaging Date (YYMMDD)', length: 6, isVariable: false },
                '15': { description: 'Best Before Date (YYMMDD)', length: 6, isVariable: false },
                '17': { description: 'Expiration Date (YYMMDD)', length: 6, isVariable: false },
                '21': { description: 'Serial Number', maxLength: 20, isVariable: true },
                '30': { description: 'Count', maxLength: 8, isVariable: true },
                '37': { description: 'Count (Trade Units)', maxLength: 8, isVariable: true },
                
                // 重量(kg) (d=0-5)
                '3100': { description: 'Net Weight (kg, d=0)', length: 6, isVariable: false, d: 0 },
                '3101': { description: 'Net Weight (kg, d=1)', length: 6, isVariable: false, d: 1 },
                '3102': { description: 'Net Weight (kg, d=2)', length: 6, isVariable: false, d: 2 },
                '3103': { description: 'Net Weight (kg, d=3)', length: 6, isVariable: false, d: 3 },
                '3104': { description: 'Net Weight (kg, d=4)', length: 6, isVariable: false, d: 4 },
                '3105': { description: 'Net Weight (kg, d=5)', length: 6, isVariable: false, d: 5 },
                
                // 他のAI... (例: 311d, 312d, 320d ... 8005, 8110)
            };

            // 小数点（d）を持つAIのプレフィックス (3桁)
            const gs1VariableDecimalAIs = [
                // (例: 310d, 311d ... 369d)
                { prefix: '310', description: 'Net Weight (kg, d=', length: 6, suffix: ')'},
                { prefix: '311', description: 'Length (m, d=', length: 6, suffix: ')'},
                { prefix: '312', description: 'Width (m, d=', length: 6, suffix: ')'},
                { prefix: '313', description: 'Height (m, d=', length: 6, suffix: ')'},
                { prefix: '314', description: 'Area (m2, d=', length: 6, suffix: ')'},
                { prefix: '315', description: 'Volume (l, d=', length: 6, suffix: ')'},
                { prefix: '316', description: 'Volume (m3, d=', length: 6, suffix: ')'},
                // 他にも多数存在
            ];


            function parseGS1Data(data) {
                let remainingData = data;
                const parsedElements = [];
                
                while (remainingData.length > 0) {
                    let aiFound = false;
                    let ai = '';
                    let def = null;
                    let dataStartIndex = 0;
                    
                    // 4桁AIからチェック (例: 3102)
                    if (remainingData.length >= 4) {
                        ai = remainingData.substring(0, 4);
                        if (gs1AIDefinitions[ai]) {
                            aiFound = true;
                            def = gs1AIDefinitions[ai];
                            dataStartIndex = 4;
                        } else {
                            // 3桁 + d のパターンチェック (例: 310d)
                            const aiPrefix = remainingData.substring(0, 3);
                            const aiVariable = gs1VariableDecimalAIs.find(d => d.prefix === aiPrefix);
                            if (aiVariable) {
                                aiFound = true;
                                const d = remainingData.substring(3, 4);
                                // aiを (例) 310d -> 3102 のようにフルで保持
                                ai = aiPrefix + d;
                                def = {
                                    description: `${aiVariable.description}${d}${aiVariable.suffix}`,
                                    length: aiVariable.length,
                                    isVariable: false,
                                    d: parseInt(d, 10) 
                                };
                                dataStartIndex = 4;
                            }
                        }
                    }

                    // 2桁AIチェック (例: 01, 10, 21)
                    if (!aiFound && remainingData.length >= 2) {
                        ai = remainingData.substring(0, 2);
                        if (gs1AIDefinitions[ai]) {
                            aiFound = true;
                            def = gs1AIDefinitions[ai];
                            dataStartIndex = 2;
                        }
                    }
                    
                    if (aiFound) {
                        remainingData = parseElement(ai, def, remainingData.substring(dataStartIndex), parsedElements);
                    } else {
                        // 不明なAIまたはデータの終わり
                        if (remainingData.length > 0) {
                             parsedElements.push({
                                ai: '??',
                                data: remainingData,
                                description: 'Unknown data or parsing error'
                            });
                        }
                        break; // ループ終了
                    }
                }
                
                return parsedElements;
            }

            function parseElement(ai, def, data, parsedElements) {
                let elementData = '';
                let remainingData = data;
                
                if (def.isVariable) {
                    // 可変長
                    const separatorIndex = data.indexOf(FNC1);
                    const maxLength = def.maxLength;
                    
                    if (separatorIndex !== -1) {
                        // FNC1 (GS) が見つかった
                        elementData = data.substring(0, separatorIndex);
                        remainingData = data.substring(separatorIndex + 1); // FNC1の次から
                        
                        if (elementData.length > maxLength) {
                            elementData = elementData.substring(0, maxLength);
                            // FNC1の位置がmaxLengthより後だった場合、FNC1は無視され、maxLengthまでがデータとなる
                            // (この実装はFNC1を優先)
                        }
                        
                    } else {
                        // FNC1なし (バーコードの終端まで)
                        if (data.length > maxLength) {
                            elementData = data.substring(0, maxLength);
                            remainingData = data.substring(maxLength);
                        } else {
                            elementData = data;
                            remainingData = '';
                        }
                    }
                } else {
                    // 固定長
                    const length = def.length;
                    if (data.length >= length) {
                        elementData = data.substring(0, length);
                        remainingData = data.substring(length);
                    } else {
                        // データが不足している
                        elementData = data; // ある分だけ
                        remainingData = '';
                    }
                }

                // 小数点処理 (例: 3102)
                if (def.d !== undefined) {
                    const d = def.d;
                    if (elementData.length === def.length) { // 期待される長さ
                        const integerPart = elementData.substring(0, def.length - d);
                        const decimalPart = elementData.substring(def.length - d);
                        elementData = `${integerPart}.${decimalPart}`;
                    }
                }

                parsedElements.push({
                    ai: ai,
                    data: elementData,
                    description: def.description
                });
                
                return remainingData;
            }
            // --- End GS1 Parser ---


            function stopScan() {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }
                codeReader.reset(); // Readerをリセット
                videoElement.srcObject = null;
                videoElement.classList.remove('hidden'); // ビデオを再表示
                uploadedImagePreview.src = '';
                uploadedImagePreview.classList.add('hidden'); // 画像プレビューを非表示
                updateStatus('スキャンが停止しました。');
                scannerGuide.classList.add('hidden');
                
                // 結果表示エリアもクリア
                resultTextarea.value = '';
                parsedResultContainer.textContent = '';
                parsedResultContainer.style.display = 'none';
                parsedResultLabel.classList.add('hidden');

                startButton.disabled = false;
                stopButton.disabled = true;
                imageUpload.closest('label').classList.remove('pointer-events-none', 'opacity-50'); // 画像アップロードボタンを有効化
            }

            function processScanResult(result) {
                if (result) {
                    console.log('Scan result:', result);
                    
                    const rawText = result.getText();
                    let formatType = "不明";
                    let gs1Data = '';

                    // AI分割結果表示エリアをクリア
                    parsedResultContainer.textContent = '';
                    parsedResultContainer.style.display = 'none';
                    parsedResultLabel.classList.add('hidden');
                    
                    if (result.getBarcodeFormat() === BarcodeFormat.CODE_128) {
                        // ASSUME_GS1 ヒントにより、]C1 が自動的に付加されることを期待
                        if (rawText.startsWith(']C1')) {
                            formatType = "GS1-128";
                            gs1Data = rawText.substring(3);
                            resultTextarea.value = gs1Data;
                            
                            // --- GS1-128の解析を実行 ---
                            const parsedElements = parseGS1Data(gs1Data);
                            
                            if (parsedElements.length > 0) {
                                // 読みやすいようにフォーマットして表示
                                const formattedOutput = parsedElements.map(el => {
                                    // データを整列させる (AI: 6桁, Data: 25桁)
                                    const aiStr = `(${el.ai})`.padEnd(7, ' ');
                                    const dataStr = el.data.padEnd(25, ' ');
                                    return `${aiStr} ${dataStr} -> ${el.description}`;
                                }).join('\n');
                                
                                parsedResultContainer.textContent = formattedOutput;
                                parsedResultContainer.style.display = 'block';
                                parsedResultLabel.classList.remove('hidden');
                            }
                            
                        } else {
                            formatType = "Code 128 (非GS1)";
                            resultTextarea.value = rawText;
                        }
                    } else {
                        formatType = result.getBarcodeFormat().toString();
                        resultTextarea.value = rawText;
                    }

                    updateStatus(`${formatType} を検出しました！`);
                    
                    if ('vibrate' in navigator) {
                        navigator.vibrate(200);
                    }
                    
                    // スキャン自体は停止するが、カメラや画像プレビューの状態は維持する
                    if (currentStream) {
                        // リアルタイムスキャン中だった場合
                         stopScan(); // カメラを停止
                    } else {
                        // 画像スキャンだった場合
                        // (画像プレビューは残し、ボタンを有効化)
                        updateStatus(`${formatType} を検出しました！`);
                        startButton.disabled = false;
                        imageUpload.closest('label').classList.remove('pointer-events-none', 'opacity-50');
                        imageUpload.value = '';
                    }

                } else {
                    updateStatus('バーコードを検出できませんでした。');
                }
            }

            startButton.addEventListener('click', async () => {
                startButton.disabled = true;
                stopButton.disabled = false;
                imageUpload.closest('label').classList.add('pointer-events-none', 'opacity-50'); // 画像アップロードボタンを無効化
                resultTextarea.value = '';
                parsedResultContainer.textContent = '';
                parsedResultContainer.style.display = 'none';
                parsedResultLabel.classList.add('hidden');
                
                updateStatus('カメラを起動中...', true);
                uploadedImagePreview.classList.add('hidden'); // 画像プレビューを非表示
                videoElement.classList.remove('hidden'); // ビデオを表示

                try {
                    const constraints = {
                        video: {
                            facingMode: 'environment'
                        }
                    };
                    
                    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    videoElement.srcObject = currentStream;
                    await videoElement.play();

                    updateStatus('バーコードをスキャンしてください...');
                    scannerGuide.classList.remove('hidden');

                    codeReader.decodeFromVideoDevice(undefined, videoElement, (result, err) => {
                        if (result) {
                            processScanResult(result);
                            // リアルタイムスキャンの場合、成功したら（processScanResult内で）stopScanが呼ばれる
                        } else if (err) {
                            if (!(err instanceof ZXing.NotFoundException) && !(err instanceof ZXing.ChecksumException) && !(err instanceof ZXing.FormatException)) {
                                console.error('Scanning error:', err);
                            }
                        }
                    });

                } catch (err) {
                    console.error('Camera access error:', err);
                    let errorMessage = 'カメラの起動に失敗しました。';
                    if (err.name === 'NotAllowedError') {
                        errorMessage = 'カメラへのアクセスが拒否されました。ブラウザの設定を確認してください。';
                    } else if (err.name === 'NotFoundError') {
                        errorMessage = '使用可能なカメラが見つかりませんでした。';
                    } else if (err.name === 'NotReadableError') {
                        errorMessage = 'カメラが他のアプリケーションで使用されている可能性があります。';
                    }
                    
                    showMessage('カメラエラー', errorMessage);
                    updateStatus('エラーが発生しました。');
                    stopScan();
                }
            });

            stopButton.addEventListener('click', stopScan);
            
            imageUpload.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                stopScan(); // カメラが動作中の場合は停止
                startButton.disabled = true; // カメラボタンを無効化
                imageUpload.closest('label').classList.add('pointer-events-none', 'opacity-50'); // アップロードボタンを無効化
                
                resultTextarea.value = ''; // 結果をクリア
                parsedResultContainer.textContent = ''; // AI結果もクリア
                parsedResultContainer.style.display = 'none';
                parsedResultLabel.classList.add('hidden');


                updateStatus('画像を解析中...', true);

                const reader = new FileReader();
                reader.onload = async (e) => {
                    // アップロードされた画像をプレビュー表示
                    videoElement.classList.add('hidden'); // ビデオを非表示
                    uploadedImagePreview.src = e.target.result;
                    uploadedImagePreview.classList.remove('hidden');
                    
                    try {
                        // Image要素からバーコードをデコード
                        const result = await codeReader.decodeFromImageUrl(e.target.result);
                        processScanResult(result); // 解析と表示

                    } catch (err) {
                        console.error('Image scan error:', err);
                        if (err instanceof ZXing.NotFoundException) {
                            showMessage('検出失敗', 'この画像からバーコードを検出できませんでした。');
                            updateStatus('画像解析に失敗しました。');
                        } else {
                            showMessage('スキャンエラー', `画像解析中にエラーが発生しました: ${err.message}`);
                            updateStatus('画像解析に失敗しました。');
                        }
                    } finally {
                        // 処理完了後、ボタンを元に戻す (processScanResultで処理される)
                        // 画像スキャンの場合、stopScan()は呼ばないため、ここでボタンを有効化
                        if (!currentStream) { // (stopScanが呼ばれていない場合)
                            startButton.disabled = false;
                            imageUpload.closest('label').classList.remove('pointer-events-none', 'opacity-50');
                            imageUpload.value = ''; // 同じ画像を再度選択できるようにファイルをクリア
                        }
                    }
                };
                reader.readAsDataURL(file);
            });

            copyButton.addEventListener('click', () => {
                const textToCopy = resultTextarea.value;
                if (!textToCopy) {
                    showMessage('コピー', 'コピーするデータがありません。');
                    return;
                }

                if (navigator.clipboard) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        showMessage('コピー完了', '結果(Raw)をクリップボードにコピーしました。');
                    }).catch(err => {
                        console.error('Clipboard API error:', err);
                        legacyCopy(textToCopy);
                    });
                } else {
                    legacyCopy(textToCopy);
                }
            });

            function legacyCopy(text) {
                try {
                    resultTextarea.select();
                    document.execCommand('copy');
                    resultTextarea.blur();
                    showMessage('コピー完了', '結果(Raw)をクリップボードにコピーしました。');
                } catch (err) {
                    console.error('Legacy copy error:', err);
                    showMessage('コピー失敗', 'クリップボードへのコピーに失敗しました。');
                }
            }

            // 初期状態設定
            updateStatus('「カメラでスキャン」または「画像からスキャン」を選択してください。');
            stopButton.disabled = true;
        });
    </script>

</body>
</html>